namespace CovidFs
open System

module Fit =
    //deaths from this model t=0 at 1/1/2020
    let act = [0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;1.0;2.0;2.0;3.0;6.0;6.0;8.0;10.0;21.0;35.0;55.0;71.0;103.0;144.0;177.0;233.0;281.0;335.0;422.0;463.0;578.0;759.0;1019.0;1228.0;1408.0;1789.0;2352.0;2921.0;3605.0;4313.0;4934.0]
    //range 0 to 95
    let rs = [3.0; 3.1; 3.2; 3.3; 3.4; 3.5; 3.6; 3.7; 3.8; 3.9; 4.0; 4.1; 4.2; 4.3; 4.4; 4.5; 4.6; 4.7; 4.8; 4.9; 5.0; 5.1; 5.2; 5.3; 5.4; 5.5; 5.6; 5.7; 5.8; 5.9; 6.0]
    let ps = [5e-09; 5.2e-09; 5.4e-09; 5.6e-09; 5.8e-09; 6e-09; 6.2e-09; 6.4e-09; 6.6e-09;
      6.8e-09; 7e-09; 7.2e-09; 7.4e-09; 7.6e-09; 7.8e-09; 8e-09; 8.2e-09; 8.4e-09;
      8.6e-09; 8.8e-09; 9e-09; 9.2e-09; 9.4e-09; 9.6e-09; 9.8e-09; 1e-08;
      1.02e-08; 1.04e-08; 1.06e-08; 1.08e-08; 1.1e-08; 1.12e-08; 1.14e-08;
      1.16e-08; 1.18e-08; 1.2e-08; 1.22e-08; 1.24e-08; 1.26e-08; 1.28e-08;
      1.3e-08]
    let fitrange = [72..95]
    let getdths p r = 
        let rest,res = Model.CalcFit(p,r,r)
        let alldths = rest.["Cumulative Deaths"]
        //let dths = fitrange|>List.map(fun i -> alldths.[i])
        //let acts = fitrange|>List.map(fun i -> act.[i])
        let sqs = fitrange|>List.map(fun i -> (act.[i] - alldths.[i])**2.0) 
        let sumsqs = sqs|>List.sum
        p,r,sumsqs
    let dofit() =
        [for p in ps do
            for r in rs do
                yield getdths p r]


    let result  = 
        let all = dofit()
        all|>List.minBy(fun (p,r,s) -> s)

